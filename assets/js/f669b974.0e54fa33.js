"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[909],{167:function(e,t,a){a.d(t,{Zo:function(){return p},kt:function(){return m}});var n=a(3289);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var s=n.createContext({}),u=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},p=function(e){var t=u(e.components);return n.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=u(a),m=i,k=d["".concat(s,".").concat(m)]||d[m]||c[m]||r;return a?n.createElement(k,o(o({ref:t},p),{},{components:a})):n.createElement(k,o({ref:t},p))}));function m(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=a.length,o=new Array(r);o[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var u=2;u<r;u++)o[u]=a[u];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},3271:function(e,t,a){a.r(t),a.d(t,{assets:function(){return p},contentTitle:function(){return s},default:function(){return m},frontMatter:function(){return l},metadata:function(){return u},toc:function(){return c}});var n=a(3830),i=a(2056),r=(a(3289),a(167)),o=["components"],l={title:"Webscraper Tutorial",description:"Guide on adding webscrapers to Energy Dashboard"},s="Webscraper Tutorial",u={unversionedId:"webscraper_tutorial",id:"webscraper_tutorial",title:"Webscraper Tutorial",description:"Guide on adding webscrapers to Energy Dashboard",source:"@site/docs/webscraper_tutorial.md",sourceDirName:".",slug:"/webscraper_tutorial",permalink:"/docs/webscraper_tutorial",draft:!1,editUrl:"https://github.com/OSU-Sustainability-Office/osu-sustainability-office.github.io/edit/main/website/docs/webscraper_tutorial.md",tags:[],version:"current",frontMatter:{title:"Webscraper Tutorial",description:"Guide on adding webscrapers to Energy Dashboard"},sidebar:"Docusaurus",previous:{title:"Database",permalink:"/docs/database"},next:{title:"Energy Dashboard Graph Logic",permalink:"/docs/energy_dashboard_graphs"}},p={},c=[{value:"General Info",id:"general-info",level:2},{value:"Automated-Jobs Dev Setup",id:"automated-jobs-dev-setup",level:2},{value:"AWS ECR (Elastic Container Registry)",id:"aws-ecr-elastic-container-registry",level:2},{value:"AWS ECS (Elastic Container Service)",id:"aws-ecs-elastic-container-service",level:2},{value:"Task Definition",id:"task-definition",level:3},{value:"Clusters",id:"clusters",level:3},{value:"AWS Cloudwatch",id:"aws-cloudwatch",level:2},{value:"Testing Pipeline Guide",id:"testing-pipeline-guide",level:2}],d={toc:c};function m(e){var t=e.components,l=(0,i.Z)(e,o);return(0,r.kt)("wrapper",(0,n.Z)({},d,l,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"webscraper-tutorial"},"Webscraper Tutorial"),(0,r.kt)("h2",{id:"general-info"},"General Info"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/OSU-Sustainability-Office/automated-jobs"},"https://github.com/OSU-Sustainability-Office/automated-jobs")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://login.oregonstate.edu/apps/aws/"},"https://login.oregonstate.edu/apps/aws/")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://pptr.dev/"},"https://pptr.dev/")),(0,r.kt)("h2",{id:"automated-jobs-dev-setup"},"Automated-Jobs Dev Setup"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://drive.google.com/file/d/12dCdA5E5e6qPgkSYehqOcX_zVy9YztFF/view?usp=sharing"},"Go here for the .env file")," - put inside the ",(0,r.kt)("inlineCode",{parentName:"li"},"automated-jobs/SEC")," directory",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Need to be a paid OSU Sustainability Office Employee to see this above link"))),(0,r.kt)("li",{parentName:"ul"},".env needs ",(0,r.kt)("inlineCode",{parentName:"li"},"DASHBOARD_API = https://api.sustainability.oregonstate.edu/v2/energy")," unless you are making changes to energy dashboard (more on this in Testing Pipeline section)")),(0,r.kt)("p",null,"In general, from the directory of any given tool (",(0,r.kt)("inlineCode",{parentName:"p"},"SEC"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"check-acq"),", etc. Note that ",(0,r.kt)("inlineCode",{parentName:"p"},"SunnyWebBox")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"Tesla Solar City")," are deprecated and no longer used)"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"npm i")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"node <Javascript file name>"),", e.g. ",(0,r.kt)("inlineCode",{parentName:"li"},"node readsec.js"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Need NodeJS v16")))),(0,r.kt)("h2",{id:"aws-ecr-elastic-container-registry"},"AWS ECR (Elastic Container Registry)"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://us-west-2.console.aws.amazon.com/ecr/repositories?region=us-west-2"},"https://us-west-2.console.aws.amazon.com/ecr/repositories?region=us-west-2")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"alt_text",src:a(1080).Z,title:"image_tooltip",width:"1496",height:"664"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"create repository",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Just follow default options"))),(0,r.kt)("li",{parentName:"ul"},"View push commands",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Start in ",(0,r.kt)("inlineCode",{parentName:"li"},"automated jobs/<scraper name>")," directory, e.g. ",(0,r.kt)("inlineCode",{parentName:"li"},"automated-jobs/SEC"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Currently, only ",(0,r.kt)("inlineCode",{parentName:"li"},"/SEC")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"check-acq")," are currently active, being the solar webscrapers and meter outage detector respectively"))),(0,r.kt)("li",{parentName:"ul"},"Need AWS CLI installed (you should already have this)"),(0,r.kt)("li",{parentName:"ul"},"Have docker desktop running in background"),(0,r.kt)("li",{parentName:"ul"},"Windows Powershell Admin",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://stackoverflow.com/questions/54776324/powershell-bug-execution-of-scripts-is-disabled-on-this-system"},"https://stackoverflow.com/questions/54776324/powershell-bug-execution-of-scripts-is-disabled-on-this-system")),(0,r.kt)("li",{parentName:"ul"},"Install-AWSToolsModule AWS.Tools.ECR"))),(0,r.kt)("li",{parentName:"ul"},"Or, use WSL / Linux / MacOS / any Unix OS"))),(0,r.kt)("li",{parentName:"ul"},"If you just want to make an update to the webscraper, you just need to edit ECR and not ECS. ECS should be configured to pick up the latest ECR revision anyways")),(0,r.kt)("h2",{id:"aws-ecs-elastic-container-service"},"AWS ECS (Elastic Container Service)"),(0,r.kt)("h3",{id:"task-definition"},"Task Definition"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"alt_text",src:a(4675).Z,title:"image_tooltip",width:"1574",height:"635"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://us-west-2.console.aws.amazon.com/ecs/v2/task-definitions?region=us-west-2"},"https://us-west-2.console.aws.amazon.com/ecs/v2/task-definitions?region=us-west-2")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Note the JSON option in existing task definitions"),(0,r.kt)("li",{parentName:"ul"},"When creating a new task definition I recommend not to use JSON, but you can use JSON of past version to double check"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("img",{alt:"alt_text",src:a(728).Z,title:"image_tooltip",width:"1600",height:"687"})))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Note Name and Image URI especially, rest can be like existing version"))),(0,r.kt)("h3",{id:"clusters"},"Clusters"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://us-west-2.console.aws.amazon.com/ecs/v2/clusters?region=us-west-2"},"https://us-west-2.console.aws.amazon.com/ecs/v2/clusters?region=us-west-2")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"alt_text",src:a(5246).Z,title:"image_tooltip",width:"1436",height:"457"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Create cluster"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"I think you can keep default options here but don\u2019t quote me. Fargate option"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Click on a cluster > scheduled tasks"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("img",{alt:"alt_text",src:a(4405).Z,title:"image_tooltip",width:"989",height:"776"})))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Click update on an existing scheduled task for reference before making a new one (have them side by side on different tabs!)"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("img",{alt:"alt_text",src:a(125).Z,title:"image_tooltip",width:"1492",height:"499"})))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"While testing something for the first time, it's a good idea to set the interval for running the CRON job as something like every minute or every 5 minutes. But once you are certain it works, make sure to turn the interval back to once every 24 hours or 48 hours etc."))),(0,r.kt)("h2",{id:"aws-cloudwatch"},"AWS Cloudwatch"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://us-west-2.console.aws.amazon.com/cloudwatch/home?region=us-west-2#logsV2:log-groups"},"https://us-west-2.console.aws.amazon.com/cloudwatch/home?region=us-west-2#logsV2:log-groups")),(0,r.kt)("p",null,"The log group may be created automatically, if not, create it. May error otherwise. This is also where you can check if the task is executed."),(0,r.kt)("p",null,"Name: ",(0,r.kt)("inlineCode",{parentName:"p"},"/ecs/<task name>")),(0,r.kt)("p",null,"See ",(0,r.kt)("a",{parentName:"p",href:"/docs/cloudwatch"},"this page on Cloudwatch")," as well for more information"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://us-west-2.console.aws.amazon.com/ecs/v2/task-definitions?region=us-west-2"},"https://us-west-2.console.aws.amazon.com/ecs/v2/task-definitions?region=us-west-2")),(0,r.kt)("p",null,"(I think)"),(0,r.kt)("h2",{id:"testing-pipeline-guide"},"Testing Pipeline Guide"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Local test with energy dashboard (both frontend and backend local), MySQL workbench",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Move on when you have successfully added new data to SQL database with ",(0,r.kt)("inlineCode",{parentName:"li"},"node readsec.js")," (or whatever you named it), and you get the right data from local frontend > inspect element > network tab"))),(0,r.kt)("li",{parentName:"ul"},"Unless you are making changes to the energy dashboard backend code, then just edit the ",(0,r.kt)("inlineCode",{parentName:"li"},"DASHBOARD_API")," value in your ",(0,r.kt)("inlineCode",{parentName:"li"},"automated-jobs/SEC/.env")," file to the production URL (",(0,r.kt)("a",{parentName:"li",href:"https://api.sustainability.oregonstate.edu/v2/energy"},"https://api.sustainability.oregonstate.edu/v2/energy"),")",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"docker build . -t test")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"docker run -t test")))),(0,r.kt)("li",{parentName:"ul"},"Local test with webscraper on Docker",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Move on when ",(0,r.kt)("inlineCode",{parentName:"li"},"docker build . -t test")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"docker run -t test")," works and successfully adds data to SQL database"))),(0,r.kt)("li",{parentName:"ul"},"If making changes to backend energy dashboard code:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Run energy dashboard backend on http://localhost:3000"),(0,r.kt)("li",{parentName:"ul"},"Edit the ",(0,r.kt)("inlineCode",{parentName:"li"},"DASHBOARD_API")," value in your ",(0,r.kt)("inlineCode",{parentName:"li"},"automated-jobs/SEC/.env")," file to the local dev URL (http://localhost:3000)"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/OSU-Sustainability-Office/energy-dashboard/blob/master/backend/dependencies/nodejs/models/meter.js#L141"},"https://github.com/OSU-Sustainability-Office/energy-dashboard/blob/master/backend/dependencies/nodejs/models/meter.js#L141")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/OSU-Sustainability-Office/energy-dashboard/blob/master/backend/app/meter.js#L88"},"https://github.com/OSU-Sustainability-Office/energy-dashboard/blob/master/backend/app/meter.js#L88"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"API_PWD")," in automated-jobs env file = ",(0,r.kt)("inlineCode",{parentName:"li"},"AQUISUITE_PWD")," value that the energy-dashboard backend expects as part of the payload"))))),(0,r.kt)("li",{parentName:"ul"},"AWS ECR and ECS",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Inspect Element > Network > see the network request sent starting with \u201cdata\u2026\u201d"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"If you just want to make an update to the webscraper, you just need to push changes to ECR and not ECS. ECS should be configured to pick up the latest ECR revision anyways")),(0,r.kt)("li",{parentName:"ul"},"Change interval to 1 minute or something to test (ECS > cluster > scheduled task > update):")))),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"alt_text",src:a(4987).Z,title:"image_tooltip",width:"1400",height:"775"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Double check this part via Cloudwatch, and also check the data entries production site directly (",(0,r.kt)("a",{parentName:"li",href:"https://dashboard.sustainability.oregonstate.edu/#/building/30/2"},"SEC Solar")," and ",(0,r.kt)("a",{parentName:"li",href:"https://dashboard.sustainability.oregonstate.edu/#/building/42/2"},"OSU Operations"),"), as well as in the SQL database via MySQL workbench"),(0,r.kt)("li",{parentName:"ul"},"Remember to delete duplicate data from SQL database",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"DELETE from Solar_Meters where id = <some id>")),(0,r.kt)("li",{parentName:"ul"},"Although redundant data ",(0,r.kt)("em",{parentName:"li"},"is")," ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/OSU-Sustainability-Office/energy-dashboard/pull/220/files#diff-6586f246008ae5ee333b803001847a4b4a69e2bbad28ff73b547375126b99a6bR80"},"handled on the frontend"),", it's good practice")))))}m.isMDXComponent=!0},1080:function(e,t,a){t.Z=a.p+"assets/images/webscraper1-4711922623a2fe6a3cc92c93cef40b5d.png"},4675:function(e,t,a){t.Z=a.p+"assets/images/webscraper2-e7c0eab78f68a7dd3ae637084e94e01f.png"},728:function(e,t,a){t.Z=a.p+"assets/images/webscraper3-cff0170b0d2acf142fc46c3d5814c441.png"},5246:function(e,t,a){t.Z=a.p+"assets/images/webscraper4-905b354cdc39a952f1c64006588bacc3.png"},4405:function(e,t,a){t.Z=a.p+"assets/images/webscraper5-580e82a51e55da399956068640b53717.png"},125:function(e,t,a){t.Z=a.p+"assets/images/webscraper6-01a8b7ad4f94c8f1807a014f0dd3f76b.png"},4987:function(e,t,a){t.Z=a.p+"assets/images/webscraper7-422387063a76cb4084ce797ae0769844.png"}}]);